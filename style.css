// script.js — MULTILINGUAL FINAL COACH

const AI_URL = "https://loops-ai-coach.seansynge.workers.dev/api/correct";

// ------------------
// GUARDRAIL: verb presence by language
// ------------------
function hasVerbLikeWord(text, lang) {
  const t = text.toLowerCase();
  if (lang === "es") return /\b(es|está|son|soy|tiene|tengo|hay|va|vive|juega|come|trabaja|gusta|gustas)\b/i.test(t);
  if (lang === "fr") return /\b(est|a|suis|es|sommes|êtes|sont|aime|joue|vit)\b/i.test(t);
  if (lang === "de") return /\b(ist|hat|bin|bist|sind|habt|spielt|lebt|mag)\b/i.test(t);
  if (lang === "ga") return /\b(tá|is|táim|tá tú|tá sé|tá sí|táimid)\b/i.test(t);
  return false;
}

// ------------------
// MULTILINGUAL TURBO HINTS
// ------------------
function nextStep(label, answer, lang) {
  const a = answer.toLowerCase();
  
  // Spanish
  if (lang === "es") {
    if (label === "Missing verb") return "Add a verb — try **es** (he is) or **tiene** (he has).";
    if (label === "Task relevance") return "Describe the person — try **es + adjective**.";
    if (label === "Agreement") return "Match the adjective — **alto → alta**, **simpático → simpática**.";
    if (label === "Verb form") {
      if (a.includes("gustas")) return "Use **gusta** (he likes), not **gustas**.";
      if (a.includes("eres")) return "Use **es** (he is), not **eres** (you are).";
      return "Check verb ending — is it he/she or you?";
    }
    if (label === "Word order") return "Start with **Mi amigo es…**";
    return "Polish it — add accents if you can.";
  }

  // French
  if (lang === "fr") {
    if (label === "Missing verb") return "Add a verb — try **est** (he is) or **a** (he has).";
    if (label === "Task relevance") return "Describe the person — try **est + adjectif**.";
    if (label === "Agreement") return "Match the adjective — **grand → grande**.";
    if (label === "Verb form") return "Check the verb ending — il/elle vs tu.";
    if (label === "Word order") return "Put the subject first, then the verb.";
    return "Polish it — check accents and spelling.";
  }

  // German
  if (lang === "de") {
    if (label === "Missing verb") return "Add a verb — try **ist** (he is) or **hat** (he has).";
    if (label === "Task relevance") return "Describe the person — try **ist + adjective**.";
    if (label === "Agreement") return "Check adjective endings — make them match the noun.";
    if (label === "Verb form") return "Check the verb ending — er vs du.";
    if (label === "Word order") return "Put subject first: **Mein Freund ist…**";
    return "Polish it — check spelling.";
  }

  // Gaeilge
  if (lang === "ga") {
    if (label === "Missing verb") return "Add a verb — try **tá sé…** (he is).";
    if (label === "Task relevance") return "Describe the person — try **tá sé + adjective**.";
    if (label === "Agreement") return "Match descriptors — make them fit the person.";
    if (label === "Verb form") return "Check verb form — tá sé vs tá tú.";
    if (label === "Word order") return "Try **Tá sé + adjective** at the start.";
    return "Polish it — check spelling if relevant.";
  }

  return "";
}

// ------------------
// AI CLASSIFIER
// ------------------
async function classifyAnswer(payload) {
  try {
    const controller = new AbortController();
    setTimeout(() => controller.abort(), 4000);

    payload.instructions = `
You are a Junior Cycle language examiner.

Name if dominant:
• Agreement
• Verb form
• Word order

Otherwise use:
• Task relevance
• Accuracy

Choose ONE focus only.
Be decisive.
Return JSON only in this format:
{
  verdict,
  scores:{structure,relevance,accuracy},
  label,
  rationale
}
`;

    const res = await fetch(AI_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
      signal: controller.signal
    });

    const text = await res.text();
    if (!res.ok) throw new Error(text);
    return JSON.parse(text);

  } catch {
    return {
      verdict: "amber",
      scores: { structure: 2, relevance: 1, accuracy: 1 },
      label: "Task relevance",
      rationale: "The sentence does not clearly describe the person."
    };
  }
}

// ------------------
// COACH VOICE
// ------------------
function coachSpeak(total, label) {
  if (total <= 3) return `Stop. Fix the ${label} and go again.`;
  if (total <= 6) return `This scores, but the ${label} is holding it back.`;
  return "Good. That scores. Push it to the top band.";
}

// ------------------
// BUTTON WIRING
// ------------------
document.addEventListener("DOMContentLoaded", () => {

  const runBtn = document.getElementById("runBtn");
  const out = document.getElementById("out");
  const answerBox = document.getElementById("answer");

  // Cursor-ready
  answerBox.value = "";
  answerBox.focus();

  runBtn.onclick = async () => {

    runBtn.disabled = true;
    runBtn.innerText = "Thinking…";

    const prompt = document.getElementById("prompt").value;
    const answer = answerBox.value.trim();
    const langCode = document.getElementById("lang").value;

    // NO VERB
    if (!hasVerbLikeWord(answer, langCode)) {
      out.classList.remove("hidden");
      out.innerHTML = `
        <div class="score">Score: 0 / 10</div>
        <div class="focus">Focus: Missing verb</div>
        <div><strong>Do this:</strong><br>${nextStep("Missing verb", answer, langCode)}</div>
      `;
      runBtn.disabled = false;
      runBtn.innerText = "Ask coach";
      return;
    }

    const language =
      langCode === "es" ? "Spanish" :
      langCode === "fr" ? "French" :
      langCode === "de" ? "German" : "Gaeilge";

    const result = await classifyAnswer({
      mode: "classifier",
      language,
      level: "Junior Cycle",
      task: "short description",
      prompt,
      answer
    });

    let s = result.scores;
    let total = s.structure + s.relevance + s.accuracy;

    // LOW-BAND CAP
    if (s.relevance <= 1 && s.structure <= 2) {
      total = Math.min(total, 4);
    }

    const hint = nextStep(result.label, answer, langCode);

    out.classList.remove("hidden");
    out.innerHTML = `
      <div class="score">Score: ${total} / 10</div>
      <div class="focus">Focus: ${result.label}</div>
      <div>${coachSpeak(total, result.label)}</div>
      <div><br><strong>Do this:</strong><br>${hint}</div>
      <div><br><em>${result.rationale}</em></div>
    `;

    runBtn.disabled = false;
    runBtn.innerText = "Ask coach";
  };
});
